machine:
  ruby:
    version: 2.3.3
  node:
    version: v6.9.2

  services:
    - docker

dependencies:
  cache_directories:
    - "~/docker"

  pre:
    - sudo apt-get update && sudo apt-get install sqlite3 libsqlite3-dev
    - if [[ -e ~/docker/image.tar ]]; then docker load -i ~/docker/image.tar; fi
  post:
    - docker build --rm=false -t buildwatch .
    - mkdir -p ~/docker; docker save buildwatch > ~/docker/image.tar

test:
  post:
    - npm run coverage
    - mkdir $CIRCLE_TEST_REPORTS/junit && cp test-results.xml $CIRCLE_TEST_REPORTS/junit/test-results.xml